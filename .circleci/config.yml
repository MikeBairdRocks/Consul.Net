version: 2.0
jobs:
  build:
    docker:
      - image: mcr.microsoft.com/dotnet/core/sdk:3.1
    steps:
      - checkout
      - run: dotnet build
  
  test:
    docker:
      - image: mcr.microsoft.com/dotnet/core/sdk:3.1
      - image: consul:1.5.2
        environment:
          - 'CONSUL_LOCAL_CONFIG={ "bind_addr": "127.0.0.1", "server": true, "bootstrap": true, "acl_datacenter": "dc1", "acl_master_token": "eba37d50-2fd8-42f2-b9f6-9c7c7a55890e", "acl_default_policy": "allow", "encrypt": "d8wu8CSUrqgtjVsvcBPmhQ==" }'
        command: agent -dev
        
    steps: 
      - checkout
      - run: dotnet test --no-build --logger "trx;LogFileName=/root/project/artifacts/junit/results.trx"
      - run:
          name: test results
          command: |
            dotnet tool install -g trx2junit
            export PATH="$PATH:/root/.dotnet/tools"
            trx2junit /root/project/artifacts/junit/results.trx
      - run:
          name: remove trx
          command: rm -f /root/project/artifacts/junit/results.trx
      - store_test_results:
          path: /root/project/artifacts/junit
      - store_artifacts:
          path: /root/project/artifacts/junit
          destination: TestResults
          
workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - test:
          requires: build